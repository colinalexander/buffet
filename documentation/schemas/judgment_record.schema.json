{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://colinalexander.github.io/buffet/documentation/schemas/judgment_record.schema.json",
  "title": "MandateOS Judgment Record (Canonical)",
  "description": "Canonical schema for auditable Judgment Records. This schema is derived from documentation/JUDGMENT_RECORD_SCHEMA.md and is intended to validate both YAML and JSON representations. Viewer UI schemas under docs/schemas/ are explicitly non-authoritative.",
  "type": "object",
  "required": [
    "record_id",
    "timestamp",
    "authority",
    "outcome",
    "confidence",
    "audit"
  ],
  "properties": {
    "record_id": {
      "type": "string",
      "minLength": 1,
      "description": "Immutable record identifier (typically a UUID)."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 UTC timestamp of the judgment instance."
    },
    "authority": { "$ref": "#/$defs/AuthorityContext" },
    "invocation": { "$ref": "#/$defs/InvocationContext" },
    "state": { "$ref": "#/$defs/StateSnapshot" },
    "outcome": { "$ref": "#/$defs/Outcome" },
    "confidence": { "$ref": "#/$defs/Confidence" },
    "constraints": { "$ref": "#/$defs/Constraints" },
    "compliance": { "$ref": "#/$defs/Compliance" },
    "behavior": { "$ref": "#/$defs/Behavior" },
    "audit": { "$ref": "#/$defs/Audit" },
    "adjustment": { "$ref": "#/$defs/AdjustmentRecommendation" },
    "inaction": { "$ref": "#/$defs/InactionJustification" },
    "escalation": { "$ref": "#/$defs/EscalationDetail" },
    "evidence": {
      "type": "array",
      "description": "Optional structured evidence supporting the judgment rationale.",
      "items": { "$ref": "#/$defs/EvidenceItem" }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "outcome": { "properties": { "type": { "const": "escalate" } }, "required": ["type"] } },
        "required": ["outcome"]
      },
      "then": { "required": ["escalation"] },
      "else": { "not": { "required": ["escalation"] } }
    },
    {
      "if": {
        "properties": {
          "outcome": { "properties": { "type": { "const": "recommend_adjustment" } }, "required": ["type"] }
        },
        "required": ["outcome"]
      },
      "then": { "required": ["adjustment"] },
      "else": { "not": { "required": ["adjustment"] } }
    }
  ],
  "additionalProperties": true,
  "$defs": {
    "OutcomeType": {
      "type": "string",
      "enum": ["affirm_alignment", "recommend_adjustment", "escalate"]
    },
    "AuthorityContext": {
      "type": "object",
      "description": "Authority binding (mandate + procedure). mandate_id and procedure_id together form the stable core identifiers for mandate_id and judgment_loop_id.",
      "required": ["mandate_id", "mandate_version", "procedure_id", "procedure_version"],
      "properties": {
        "mandate_id": { "type": "string", "minLength": 1 },
        "mandate_version": { "type": "string", "minLength": 1 },
        "procedure_id": { "type": "string", "minLength": 1, "description": "Judgment loop identifier." },
        "procedure_version": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": true
    },
    "InvocationContext": {
      "type": "object",
      "description": "Optional invocation context (why the procedure ran). Vocabulary may evolve by procedure and mandate.",
      "properties": {
        "trigger_type": {
          "type": "string",
          "minLength": 1,
          "description": "Procedure-defined trigger type (e.g., state_change, threshold_breach, confidence_degradation, scheduled_review)."
        },
        "trigger_description": { "type": "string", "minLength": 1 },
        "persistence_evidence": { "type": ["string", "null"] }
      },
      "additionalProperties": true
    },
    "StateSnapshot": {
      "type": "object",
      "description": "Minimal sufficient observed state snapshot at time of judgment.",
      "properties": {
        "portfolio_summary": { "type": "object", "additionalProperties": true },
        "environment_summary": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": true
    },
    "Outcome": {
      "type": "object",
      "description": "Judgment decision and rationale. outcome.type is the stable canonical decision enum; outcome.rationale is the preferred canonical rationale field.",
      "required": ["type"],
      "properties": {
        "type": { "$ref": "#/$defs/OutcomeType" },
        "rationale": { "type": "string", "minLength": 1 },
        "description": { "type": "string", "minLength": 1, "deprecated": true }
      },
      "anyOf": [{ "required": ["rationale"] }, { "required": ["description"] }],
      "additionalProperties": true
    },
    "Confidence": {
      "type": "object",
      "description": "Confidence assessment. confidence.level is the stable canonical confidence value; other fields are procedure-defined and may evolve.",
      "required": ["level"],
      "properties": {
        "level": { "type": "number", "minimum": 0, "maximum": 1 },
        "trend": { "type": "string", "minLength": 1 },
        "attribution": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": true
    },
    "Constraints": {
      "type": "object",
      "description": "Optional constraint check section; shape may evolve by mandate and procedure.",
      "properties": {
        "hard_constraints_breached": { "type": "boolean" },
        "constraints_at_risk": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        }
      },
      "additionalProperties": true
    },
    "Compliance": {
      "type": "object",
      "description": "Optional procedural compliance declaration; may evolve by procedure.",
      "properties": {
        "procedure_followed": { "type": "boolean" },
        "deviations": { "type": ["array", "null"], "items": { "type": "string", "minLength": 1 } }
      },
      "additionalProperties": true
    },
    "Behavior": {
      "type": "object",
      "description": "Optional minimal behavioral telemetry; keys and detail level may evolve.",
      "properties": {
        "tool_calls": { "type": "integer", "minimum": 0 },
        "procedure_branches_taken": { "type": "array", "items": { "type": "string", "minLength": 1 } },
        "decision_latency_ms": { "type": "integer", "minimum": 0 },
        "escalated": { "type": "boolean" },
        "inaction": { "type": "boolean" }
      },
      "additionalProperties": true
    },
    "Audit": {
      "type": "object",
      "description": "Audit and retention metadata. immutable is required and must be true for append-only records.",
      "required": ["immutable"],
      "properties": {
        "retained_until": {
          "type": "string",
          "description": "ISO-8601 date (YYYY-MM-DD) after which retention is no longer required.",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },
        "immutable": { "type": "boolean", "const": true },
        "superseded_by": { "type": ["string", "null"] }
      },
      "additionalProperties": true
    },
    "AdjustmentRecommendation": {
      "type": "object",
      "required": ["adjustment_unit", "recommended_changes", "mandate_constraints_checked"],
      "properties": {
        "adjustment_unit": {
          "type": "string",
          "minLength": 1,
          "description": "Procedure-defined adjustment unit (commonly 'exposure')."
        },
        "recommended_changes": { "type": "array", "items": { "type": "string", "minLength": 1 }, "minItems": 1 },
        "mandate_constraints_checked": { "type": "boolean" }
      },
      "additionalProperties": true
    },
    "InactionJustification": {
      "type": "object",
      "required": ["justification", "risks_acknowledged"],
      "properties": {
        "justification": { "type": "string", "minLength": 1 },
        "risks_acknowledged": { "type": "array", "items": { "type": "string", "minLength": 1 } }
      },
      "additionalProperties": true
    },
    "EscalationDetail": {
      "type": "object",
      "required": ["escalation_reason", "human_authority_required", "automated_actions_suspended"],
      "properties": {
        "escalation_reason": { "type": "string", "minLength": 1 },
        "human_authority_required": { "type": "array", "items": { "type": "string", "minLength": 1 }, "minItems": 1 },
        "automated_actions_suspended": { "type": "boolean", "const": true }
      },
      "additionalProperties": true
    },
    "EvidenceItem": {
      "type": "object",
      "description": "Optional evidence item supporting the judgment record.",
      "required": ["evidence_type", "summary"],
      "properties": {
        "evidence_type": { "type": "string", "minLength": 1 },
        "summary": { "type": "string", "minLength": 1 },
        "source": { "type": ["string", "null"] },
        "observed_at": { "type": ["string", "null"], "format": "date-time" }
      },
      "additionalProperties": true
    }
  }
}
